//@version=5
indicator("Advisor Universal Portfolio", overlay=true)

// --- SETTINGS ---
portfolio_string = input.text_area(
     defval="TSLA:279, NVDA:135.50, AAPL:180, BMNR:34", 
     title="Portfolio Data", 
     tooltip="Format: TICKER:PRICE, TICKER:PRICE"
     )

show_labels = input.bool(true, "Show Labels")

// --- PARSING LOGIC ---
get_my_price(data_str) =>
    float price_found = 0.0
    clean_data = str.replace_all(data_str, " ", "")
    items = str.split(clean_data, ",")
    for item in items
        pair = str.split(item, ":")
        if array.size(pair) == 2
            ticker_in_list = array.get(pair, 0)
            price_in_list = array.get(pair, 1)
            if ticker_in_list == syminfo.ticker
                price_found := str.tonumber(price_in_list)
    price_found

// --- GET PRICE ---
avg_price = get_my_price(portfolio_string)

// --- CALCULATE LEVELS ---
level_20 = avg_price * 1.20
level_50 = avg_price * 1.50
level_100 = avg_price * 2.00

// --- PLOT LINES ---
plot(avg_price > 0 ? avg_price : na, "Average Price", color=color.white, linewidth=1, style=plot.style_circles)
plot(avg_price > 0 ? level_20 : na, "+20% Target", color=color.yellow, style=plot.style_circles)
plot(avg_price > 0 ? level_50 : na, "+50% Target", color=color.orange, linewidth=2)
plot(avg_price > 0 ? level_100 : na, "Free Ride (2x)", color=color.green, linewidth=3)

// --- ALERTS ---
alertcondition(ta.crossover(close, level_20), title="20% Gain", message="Advisor Alert: {{ticker}} is up 20%")
alertcondition(ta.crossover(close, level_50), title="50% Gain", message="Advisor Alert: {{ticker}} is up 50% (Secure Half)")
alertcondition(ta.crossover(close, level_100), title="100% Gain", message="Advisor Alert: {{ticker}} has doubled (Free Ride)")

// --- LABELS (FIXED) ---
if show_labels and barstate.islast and avg_price > 0
    // 1. Average Price Label
    label.new(bar_index, avg_price, "Avg: " + str.tostring(avg_price, "#.##"), style=label.style_label_left, color=color.gray, textcolor=color.white)
    
    // 2. The missing 20% Label (Added Here)
    label.new(bar_index, level_20, "+20%: " + str.tostring(level_20, "#.##"), style=label.style_label_left, color=color.yellow, textcolor=color.black)
    
    // 3. 50% and 100% Labels
    label.new(bar_index, level_50, "+50%: " + str.tostring(level_50, "#.##"), style=label.style_label_left, color=color.orange, textcolor=color.white)
    label.new(bar_index, level_100, "Free Ride: " + str.tostring(level_100, "#.##"), style=label.style_label_left, color=color.green, textcolor=color.white)
